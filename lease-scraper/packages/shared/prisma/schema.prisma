generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Source {
  id        String   @id @default(cuid())
  name      String   @unique
  baseUrl   String
  createdAt DateTime @default(now())

  listings   Listing[]
  ingestRuns IngestRun[]
}

model Listing {
  id              String    @id @default(cuid())
  sourceId        String
  sourceListingId String?
  canonicalUrl    String
  title           String?
  street          String?
  unit            String?
  city            String?
  state           String?
  zip             String?
  lat             Float?
  lng             Float?
  priceMin        Float?
  priceMax        Float?
  beds            Int?
  baths           Float?
  sqft            Int?
  propertyType    String?
  availabilityDate DateTime?
  leaseTerm       String?
  deposit         Float?
  feesJson        Json?
  amenitiesJson   Json?
  description     String?
  contactJson     Json?
  rawJson         Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  scrapedAt       DateTime  @default(now())

  source Source         @relation(fields: [sourceId], references: [id])
  images ListingImage[]

  @@unique([sourceId, sourceListingId])
  @@unique([sourceId, canonicalUrl])
  @@index([city])
  @@index([priceMin, priceMax])
  @@index([beds])
  @@index([baths])
  @@index([lat, lng])
  @@index([availabilityDate])
}

model ListingImage {
  id             String  @id @default(cuid())
  listingId      String
  sortOrder      Int     @default(0)
  originalUrl    String
  storedUrl      String?
  storedPath     String?
  width          Int?
  height         Int?
  mimeType       String?
  checksumSha256 String?
  createdAt      DateTime @default(now())

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([checksumSha256])
}

model IngestRun {
  id               String    @id @default(cuid())
  sourceId         String
  startedAt        DateTime  @default(now())
  finishedAt       DateTime?
  status           String    @default("running")
  listingsUpserted Int       @default(0)
  listingsSkipped  Int       @default(0)
  imagesDownloaded Int       @default(0)
  errorsJson       Json?
  checkpoint       Json?

  source Source @relation(fields: [sourceId], references: [id])

  @@index([sourceId])
  @@index([startedAt])
}
